# DPB-004: 投稿記録ストレージ機能

## 基本情報

| 項目       | 内容                   |
| ---------- | ---------------------- |
| タスクID   | DPB-004                |
| タスク名   | 投稿記録ストレージ機能 |
| Phase      | Phase 1: コア機能      |
| 優先度     | 必須                   |
| ステータス | 完了                   |
| 関連機能ID | F-10 (仕様書 Sec. 10)  |
| 関連画面ID | -                      |

## 概要

重複投稿を防止するため、投稿済みの論文IDを永続化する機能を実装します。MVPでは、リポジトリ内のJSONファイルをデータストアとして使用します。

## やること

- [x] `internal/storage` パッケージを作成する。
- [x] `data/posted.json` ファイルを読み込む機能を実装する。
- [x] `data/posted.json` ファイルに新しい投稿記録を書き込む機能を実装する。
- [x] 指定された論文IDが既に投稿済みかどうかを判定する機能を提供する。
- [x] ファイルの読み書きがスレッドセーフである必要はない（バッチ処理のため）。

## 方針

- データストアとして `data/posted.json` を利用する。
- ファイルの読み書きには `os` パッケージ、JSONの操作には `encoding/json` を使用する。
- `Storage` 構造体を定義し、投稿済みIDのリストをメモリ上にキャッシュする。

## 方法

### 1. JSONの構造定義

```go
// internal/storage/record.go
package storage

type PostedEntry struct {
	Date  string `json:"date"`
	Venue string `json:"venue"`
}

type PostedData struct {
	Posted map[string]PostedEntry `json:"posted"`
}
```

### 2. ストレージサービスの実装

```go
// internal/storage/json_storage.go
package storage

import (
	"encoding/json"
	"os"
	"path/filepath"
	"time"
)

const storagePath = "data/posted.json"

type JSONStorage struct {
	data *PostedData
	path string
}

func NewJSONStorage() (*JSONStorage, error) {
	absPath, err := filepath.Abs(storagePath)
	if err != nil {
		return nil, err
	}

	s := &JSONStorage{path: absPath}
	if err := s.load(); err != nil {
		return nil, err
	}
	return s, nil
}

// load はJSONファイルからデータを読み込む
func (s *JSONStorage) load() error {
	s.data = &PostedData{Posted: make(map[string]PostedEntry)}

	bytes, err := os.ReadFile(s.path)
	if err != nil {
		if os.IsNotExist(err) {
			// ファイルが存在しない場合は初期状態として許容
			return nil
		}
		return err
	}

	if len(bytes) == 0 {
		// ファイルが空の場合も初期状態として許容
		return nil
	}

	return json.Unmarshal(bytes, s.data)
}

// IsPosted はIDが投稿済みかチェックする
func (s *JSONStorage) IsPosted(paperID string) bool {
	_, exists := s.data.Posted[paperID]
	return exists
}

// Add は新しい投稿記録を追加する
func (s *JSONStorage) Add(paperID, venue string) {
	s.data.Posted[paperID] = PostedEntry{
		Date:  time.Now().UTC().Format("2006-01-02"),
		Venue: venue,
	}
}

// Save は現在のデータをJSONファイルに書き込む
func (s *JSONStorage) Save() error {
	// ディレクトリが存在しない場合に作成
	dir := filepath.Dir(s.path)
	if _, err := os.Stat(dir); os.IsNotExist(err) {
		if err := os.MkdirAll(dir, 0755); err != nil {
			return err
		}
	}

	bytes, err := json.MarshalIndent(s.data, "", "  ")
	if err != nil {
		return err
	}
	return os.WriteFile(s.path, bytes, 0644)
}
```

## 成果物

- [x] `internal/storage` パッケージ
- [x] `data/posted.json` の読み書き、判定を行うサービス
- [x] ユニットテスト

## 依存タスク

- DPB-001: プロジェクト初期設定と基本構造

## 後続タスク

- DPB-005: 論文選定ロジック実装
- DPB-007: メインプロセスと実行フローの統括
