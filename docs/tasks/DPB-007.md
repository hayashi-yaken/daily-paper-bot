# DPB-007: メインプロセスと実行フローの統括

## 基本情報

| 項目       | 内容                             |
| ---------- | -------------------------------- |
| タスクID   | DPB-007                          |
| タスク名   | メインプロセスと実行フローの統括 |
| Phase      | Phase 2: 統合                    |
| 優先度     | 必須                             |
| ステータス | 未着手                           |
| 関連機能ID | F-06 (仕様書 Sec. 6)             |
| 関連画面ID | -                                |

## 概要

`cmd/dailybot/main.go` に、これまで実装した各コンポーネント（設定、クライアント、ストレージ、選定、通知）を統合し、仕様書通りの実行フローを実現します。

## やること

- [ ] `main` 関数でアプリケーションの実行フローを実装する。
- [ ] 各コンポーネントを初期化し、依存性を注入（Dependency Injection）する。
- [ ] 仕様書「6.2 実行フロー」のステップを順に実行する。
- [ ] エラーハンドリングを実装し、いずれかのステップで失敗した場合は非ゼロのexit codeで終了させる。
- [ ] 実行状況に関するログ（取得件数、選定IDなど）を標準出力に出力する。
- `dry-run` モードに対応し、`true` の場合は実際の投稿を行わずログ出力のみで終了する。

## 方針

- `main` 関数は処理の呼び出し順序を管理する責務に集中させる。
- 各コンポーネントはインターフェースを介して疎に結合させる。
- Go標準の `log` パッケージを利用してログ出力を行う。

## 方法

### 1. main.goの実装

```go
// cmd/dailybot/main.go
package main

import (
	"daily-paper-bot/internal/config"
	"daily-paper-bot/internal/formatter"
	"daily-paper-bot/internal/notifier"
	"daily-paper-bot/internal/openreview"
	"daily-paper-bot/internal/selector"
	"daily-paper-bot/internal/storage"
	"log"
	"os"
)

func main() {
	if err := run(); err != nil {
		log.Fatalf("FATAL: %v", err)
	}
	log.Println("INFO: Process completed successfully.")
}

func run() error {
	// 1. 設定を読み込み
	cfg, err := config.Load()
	if err != nil {
		return err
	}

	// 2. 各コンポーネントを初期化
	orClient := openreview.NewClient()
	jsonStorage, err := storage.NewJSONStorage()
	if err != nil {
		return err
	}
	paperSelector := selector.NewRandomSelector(jsonStorage.IsPosted)

	var paperNotifier notifier.Notifier
	if cfg.TargetPlatform == "slack" {
		paperNotifier = notifier.NewSlackNotifier(cfg.SlackBotToken, cfg.SlackChannelID)
	} else {
		paperNotifier = notifier.NewDiscordNotifier(cfg.DiscordWebhookURL)
	}

	// 3. OpenReviewから論文一覧を取得
	papers, err := orClient.GetPapers(cfg.Venue)
	if err != nil {
		return err
	}
	log.Printf("INFO: Fetched %d papers from OpenReview.", len(papers))

	// 4. 論文を選定
	selectedPaper, err := paperSelector.Select(papers)
	if err != nil {
		if err == selector.ErrNoCandidates {
			log.Println("INFO: No new papers to post.")
			return nil // 候補なしは正常終了
		}
		return err
	}
	log.Printf("INFO: Selected paper: %s (%s)", selectedPaper.GetTitle(), selectedPaper.GetID())

	// 5. 投稿 & 記録
	if !cfg.DryRun {
		// 投稿メッセージを生成
		message := formatter.FormatPaper(selectedPaper, cfg.AbstractMaxChars)
		// 投稿
		if err := paperNotifier.Post(message); err != nil {
			return err // 投稿失敗時は記録しない
		}
		// 投稿済み記録を保存
		jsonStorage.Add(selectedPaper.GetID(), cfg.Venue)
		if err := jsonStorage.Save(); err != nil {
			return err
		}
		log.Printf("INFO: Successfully posted to %s.", cfg.TargetPlatform)
	} else {
		log.Println("INFO: Dry run mode. Skipping post and save.")
	}

	return nil
}
```

## 成果物

- [ ] 実行可能な `main.go`
- [ ] アプリケーション全体の統合テスト（可能であれば）

## 依存タスク

- DPB-002: 設定管理機能
- DPB-003: OpenReviewクライアント実装
- DPB-004: 投稿記録ストレージ機能
- DPB-005: 論文選定ロジック実装
- DPB-006: 通知サービス（Slack/Discord）

## 後続タスク

- DPB-008: GitHub Actions ワークフロー設定
