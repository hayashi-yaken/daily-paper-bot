# DPB-007: メインプロセスと実行フローの統括

## 基本情報

| 項目       | 内容                             |
| ---------- | -------------------------------- |
| タスクID   | DPB-007                          |
| タスク名   | メインプロセスと実行フローの統括 |
| Phase      | Phase 2: 統合                    |
| 優先度     | 必須                             |
| ステータス | 完了                             |
| 関連機能ID | F-06 (仕様書 Sec. 6)             |
| 関連画面ID | -                                |

## 概要

`cmd/dailybot/main.go` に、これまで実装した各コンポーネント（設定、クライアント、ストレージ、選定、通知）を統合し、仕様書通りの実行フローを実現します。

## やること

- [x] `main` 関数でアプリケーションの実行フローを実装する。
- [x] 各コンポーネントを初期化し、依存性を注入（Dependency Injection）する。
- [x] 仕様書「6.2 実行フロー」のステップを順に実行する。
- [x] エラーハンドリングを実装し、いずれかのステップで失敗した場合は非ゼロのexit codeで終了させる。
- [x] 実行状況に関するログ（取得件数、選定IDなど）を標準出力に出力する。
- [x] `dry-run` モードに対応し、`true` の場合は実際の投稿を行わずログ出力のみで終了する。

## 方針

- `main` 関数は処理の呼び出し順序を管理する責務に集中させる。
- 各コンポーネントはインターフェースを介して疎に結合させる。
- Go標準の `log` パッケージを利用してログ出力を行う。

## 方法

### 1. main.goの実装

```go
// cmd/dailybot/main.go
package main

import (
	"errors"
	"fmt"
	"log"

	"github.com/hayashi-yaken/daily-paper-bot/internal/config"
	"github.com/hayashi-yaken/daily-paper-bot/internal/formatter"
	"github.com/hayashi-yaken/daily-paper-bot/internal/notifier"
	"github.com/hayashi-yaken/daily-paper-bot/internal/openreview"
	"github.com/hayashi-yaken/daily-paper-bot/internal/selector"
	"github.com/hayashi-yaken/daily-paper-bot/internal/storage"
	"github.com/joho/godotenv"
)

func main() {
	// .envファイルを読み込む
	_ = godotenv.Load()

	if err := run(); err != nil {
		log.Fatalf("FATAL: %v", err)
	}
	log.Println("INFO: Process completed successfully.")
}

func run() error {
	// 1. 設定を読み込み
	log.Println("INFO: Loading configuration...")
	cfg, err := config.Load()
	if err != nil {
		return fmt.Errorf("failed to load config: %w", err)
	}

	// 2. 各コンポーネントを初期化
	log.Println("INFO: Initializing components...")
	orClient := openreview.NewClient(cfg.CustomUserAgent)
	jsonStorage, err := storage.NewJSONStorage()
	if err != nil {
		return fmt.Errorf("failed to initialize storage: %w", err)
	}
	paperSelector := selector.NewRandomSelector(jsonStorage.IsPosted)

	var paperNotifier notifier.Notifier
	switch cfg.TargetPlatform {
	case "slack":
		paperNotifier = notifier.NewSlackNotifier(cfg.SlackBotToken, cfg.SlackChannelID)
		log.Println("INFO: Notifier set to Slack.")
	case "discord":
		paperNotifier = notifier.NewDiscordNotifier(cfg.DiscordWebhookURL)
		log.Println("INFO: Notifier set to Discord.")
	}

	// 3. OpenReviewから論文一覧を取得
	log.Printf("INFO: Fetching papers from OpenReview (Venue: %s)...", cfg.Venue)
	notes, err := orClient.GetNotes(cfg.Venue)
	if err != nil {
		return fmt.Errorf("failed to get notes from openreview: %w", err)
	}
	log.Printf("INFO: Fetched %d papers.", len(notes))

	// 4. 論文を選定
	papers := make([]selector.Paper, len(notes))
	for i := range notes {
		papers[i] = &notes[i]
	}

	log.Println("INFO: Selecting a paper...")
	selectedPaper, err := paperSelector.Select(papers)
	if err != nil {
		if errors.Is(err, selector.ErrNoCandidates) {
			log.Println("INFO: No new papers to post. Nothing to do.")
			return nil // 候補なしは正常終了
		}
		return fmt.Errorf("failed to select paper: %w", err)
	}
	log.Printf("INFO: Selected paper: %s (ID: %s)", selectedPaper.GetTitle(), selectedPaper.GetID())

	// 5. 投稿メッセージを生成
	selectedNote, ok := selectedPaper.(*openreview.Note)
	if !ok {
		return fmt.Errorf("selected paper is not of type *openreview.Note")
	}
	message := formatter.FormatPaper(selectedNote, cfg.Venue, cfg.Year, cfg.AbstractMaxChars)

	// 6. DryRun または 投稿 & 記録
	if cfg.DryRun {
		log.Println("INFO: Dry run mode is enabled. Skipping post and save.")
		log.Printf("--- Message to be posted ---\n%s\n--------------------------", message)
		return nil
	}

	log.Printf("INFO: Posting to %s...", cfg.TargetPlatform)
	if err := paperNotifier.Post(message); err != nil {
		return fmt.Errorf("failed to post notification: %w", err)
	}
	log.Println("INFO: Post successful.")

	log.Println("INFO: Saving posted record...")
	jsonStorage.Add(selectedPaper.GetID(), cfg.Venue)
	if err := jsonStorage.Save(); err != nil {
		return fmt.Errorf("failed to save posted record: %w", err)
	}
	log.Println("INFO: Record saved.")

	return nil
}
```


## 成果物

- [x] 実行可能な `main.go`
- [x] アプリケーション全体の統合テスト（可能であれば）

## 依存タスク

- DPB-002: 設定管理機能
- DPB-003: OpenReviewクライアント実装
- DPB-004: 投稿記録ストレージ機能
- DPB-005: 論文選定ロジック実装
- DPB-006: 通知サービス（Slack/Discord）

## 後続タスク

- DPB-008: GitHub Actions ワークフロー設定
